$(function(){function e(){_.transaction(function(e){e.executeSql('SELECT * FROM mobilelist WHERE mIndex = "mContent"',[],function(e,t){if(console.log("查询数据成功!"),t.rows.length>0){var i=t.rows[0].mStr;$(".mobiContant").html(i);new Swiper(".swiper-container",{pagination:".pagination",autoplay:2e3,speed:300,loop:!0,observer:!0,observeParents:!0,autoplayDisableOnInteraction:!1})}},function(e,t){console.log(t.source+"::"+t.message)})})}function t(t,i,a){_.transaction(function(n){n.executeSql("INSERT INTO mobilelist VALUES(?,?,?)",[t,i,a],function(t,i){console.log("成功保存数据!"),e()},function(e,t){console.log(t.source+"::"+t.message)})})}function i(e,i,a){_.transaction(function(n){n.executeSql("DELETE FROM mobilelist where mIndex=?",[e],function(n){console.log("删除数据成功!"),t(e,i,a)},function(e,t){console.log(t.source+"::"+t.message)})})}function a(e,t,a){i(e,h,a)}function n(){$(".more_pic").ace_file_input({style:"well",no_icon:"",btn_choose:"点击选择",btn_change:null,icon_remove:"ace-icon fa fa-times",droppable:!0,thumbnail:"small",maxSize:204e3,allowExt:["jpeg","jpg","png","gif"],allowMime:["image/jpg","image/jpeg","image/png","image/gif"],before_remove:function(){return!b}})}function o(e){return str_image_item='<tr class="image_item"><td style="vertical-align: middle;"><input class="sku_id" type="text" name="sku_id[]" placeholder="skuid/其他" style="width:100px;"></td><td style="vertical-align: middle;width:250px;max-width: 250px;"><input  type="file" class="more_pic" name="more_pic[]" multiple="" ></td><td style="vertical-align: middle;"><select class="pic_target" name="pic_target[]"><option value="0">无</option><option value="1">商品</option><option value="2">店铺</option><option value="3">专题活动页</option><option value="4">其他自定义</option></select></td><td class="target_link" style="vertical-align: middle;"><input class="pic_link" type="text" value="http://" name="pic_link[]" readonly="readonly" placeholder="http://" style="min-width:350px;"></td><td style="vertical-align: middle;text-align:center;"><i class="item_del red ace-icon fa fa-trash-o bigger-150"></i></td></tr>',str_image_item}function l(e){$(e).on("blur",".sku_id",function(){var e=/^[0-9a-zA-a]*$/g,t=$(this).val();e.test(t)||($(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("请输入数字、字母!"),$(this).val(""))})}function d(e){var t=e.parents(".image_item");e.unbind("blur").blur(function(){var i=e.val();$.ajax({url:"/mobile/checksku.html",type:"POST",dataType:"json",async:!1,data:{sku_id:i},success:function(i){console.log(i),"success"!=i.msg?($(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("skuId错误,请核对!"),e.val(""),t.find(".goodsimglogo").attr("src",""),t.find(".goodsname").html(""),t.find(".goodsshopprice").html(""),t.find(".goodsmarketprice").html("")):"success"==i.msg&&(t.find(".goodsimglogo").attr("src",i.data.S_Logo),t.find(".goodsname").html(i.data.S_Name),t.find(".goodsshopprice").html(i.data.S_MarketPrice),t.find(".goodsmarketprice").html(i.data.S_ShopPrice))}})})}function s(e){$(e).on("change",".pic_target",function(){var e=parseInt($(this).val()),t=$(this).parents("tr").find(".sku_id"),i=$(this).parent("td").next("td").find("input"),a=$("input[name='url_item']").val(),n=$("input[name='url_store']").val(),o=$("input[name='url_sale_activity']").val();switch(e){case 0:i.attr("readonly","readonly"),i.val("http://");break;case 1:d(t),i.attr("readonly","readonly"),i.val(a+t.val()+".html");break;case 2:i.attr("readonly","readonly"),i.val(n+t.val()+".html");break;case 3:i.attr("readonly","readonly"),i.val(o+t.val()+".html");break;case 4:i.removeAttr("readonly"),i.val("http://")}})}function r(e){var t=e.parents(".modal").find(".modal-body").find(".image_content"),i=[];t.find("input[type=text]").each(function(){i.push($(this).val())});var a=[];t.find("tr").each(function(){var e=$(this).find("label").find("img").attr("class");void 0!=e&&a.push(e)});var n=a.length,o=parseInt(n),l=parseInt(t.parents(".modal-body").find(".display_more_pic").find("li").length);return{arrTbVal:i,arrTbImg:a,numTbLen:o,ulTbLen:l}}function c(e,t,i,l){$(e).click(function(){var e=$("<div></div>"),l=$("<ul></ul>"),d=Math.floor(1e4*Math.random());e.attr("class","module module_"+d),l.attr("class","modulePanel "+t+" "+t+"_"+d),$(".mobiContant").append(e),$(".module_"+d).append(m()),$(".module_"+d).append(l),$(i).unbind("click").click(function(){function e(e){if(s.numTbLen==s.ulTbLen){var i=[];l.parent(".modal-footer").prev(".modal-body").find(".image_content").find(".image_item").each(function(){var e=$(this).find(".sku_id").val();i.push(e)}),console.log(i);for(var r=i.join(",")+",",c=0;c<i.length;c++)if(r.replace(i[c]+",","").indexOf(i[c]+",")>-1)return $(".alert_txt").show(),void $(".alert_txt").find(".modal-body").html("楼层重复元素为"+i[c]+"请核对!");for(var m=e.parents(".modal").attr("id"),u=y.length,f="",c=0;c<u;c++)f+="<li>",1==y[c].pic_target?f+="<a data-target="+y[c].pic_target+'  target="_blank" class="open-goods-detail"  data-goods-id="'+y[c].sku_id+'">':2==y[c].pic_target?f+="<a data-target="+y[c].pic_target+'  target="_blank" class="open-shop"  data-shop-id="'+y[c].sku_id+'">':f+='<a href="'+y[c].pic_link+'"   data-target='+y[c].pic_target+'  target="_blank"  data-goods-id="'+y[c].sku_id+'">',f+='<img src="'+y[c].pic+'">',f+="</a>",f+="</li>";$("."+t+"_"+d).append(f),$("."+t+"_"+d).attr("data-id",m);var h=[];$("."+t+"_"+d).find("li").each(function(){h.push($(this).find("img").height())}),"adv_pic"==t&&$("."+t+"_"+d).find("li").each(function(){var e=$(this);$(this).css({height:e.find("img").height()+"px"})}),$("."+t+"_"+d).find("li").each(function(){$(this).prepend(p())}),e.parent(".modal-footer").prev(".modal-body").find(".image_content").html(o()),e.parent(".modal-footer").prev(".modal-body").find(".display_more_pic").html(""),n();var _=$(".mobiContant").find(".module").length;$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();a("mContent",_,$(".mobiContant").html());a("module_"+d,"",$(".module_"+d).html()),$("#"+m).modal("hide")}else $(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("请上传参数!")}var l=$(this),s=r(l);-1!=i.indexOf("adv")?-1==$.inArray("0",s.arrTbImg)?e(l):($(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("参数不能为空!")):-1==$.inArray("",s.arrTbVal)&&-1==$.inArray("0",s.arrTbImg)?e(l):($(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("参数不能为空!"))})})}function m(e){var t="";return t+='<div class="modulePanelBg">',t+='<button data-toggle="modal" data-target="#modalEdit" class="edit_module btn btn-primary btn-xs ">编辑模块</button>',t+='<button data-toggle="modal" data-target="#setStyle" class="set_module btn btn-primary btn-xs ">设置样式</button>',t+='<div class="moduleBtn action-buttons">',t+='<span class="module_del"><a><i class="fa fa-times" aria-hidden="true"></i></a></span>',0!=e&&(t+='<span class="module_up"><a><i class="fa fa-long-arrow-up" aria-hidden="true"></i></a></span>'),t+='<span class="module_down"><a><i class="fa fa-long-arrow-down" aria-hidden="true"></i></a></span>',t+="</div>",t+="</div>"}function p(){return'<a class="moduleItemBg"><span data-toggle="modal" data-target="#setStyle" class="moduleItemEdit"><i class="fa fa-pencil" aria-hidden="true"></i></span><span class="moduleItemDel"><i class="fa fa-times" aria-hidden="true"></i></span></a>'}function u(e,t,i){var a=e.parent(".modal-footer").prev(".modal-body"),n=new RegExp("px","g"),o="",l="",d="",s="",r="";1==a.find("input[name=border_style]:checked").val()?(o=a.find("input[name=border_color]").val(),l=a.find("select[name=border_width]").val(),d=a.find("select[name=border_style]").val(),s=a.find("select[name=border_radius]").val()):(r=t.css("border"),s=t.css("border-radius").replace(n,"")),o=""==o?"#fff":o,""==l?l="0px":l+="px",d=""==d?"none":d,""==s?s="0":s+="px",r=""==r?o+" "+l+" "+d:r;var c="";c=1==a.find("input[name=height_style]:checked").val()?-1==(c=""==(c=a.find("input[name=height]").val())?t.css("height"):c).indexOf("%")?c.replace(n,"")+"px":c:t.css("height");var m="",p="",u="",f="",h="";1==a.find("input[name=margin_style]:checked").val()?(m=a.find("input[name=margin_left]").val(),p=a.find("input[name=margin_right]").val(),u=a.find("input[name=margin_top]").val(),f=a.find("input[name=margin_down]").val(),m=""==m?t.css("margin-left"):m,p=""==p?t.css("margin-right"):p,u=""==u?t.css("margin-top"):u,f=""==f?t.css("margin-bottom"):f,m=-1==m.indexOf("%")?m.replace(n,"")+"px":m,p=-1==p.indexOf("%")?p.replace(n,"")+"px":p,u=-1==u.indexOf("%")?u.replace(n,"")+"px":u,f=-1==f.indexOf("%")?f.replace(n,"")+"px":f):h=t.css("margin"),h=""==h?u+" "+p+" "+f+" "+m:h;var _="",g="",v="",$="",b="";1==a.find("input[name=padding_style]:checked").val()?(_=a.find("input[name=padding_left]").val(),g=a.find("input[name=padding_right]").val(),v=a.find("input[name=padding_top]").val(),$=a.find("input[name=padding_down]").val(),_=""==_?t.css("padding-left"):_,g=""==g?t.css("padding-right"):g,v=""==v?t.css("padding-top"):v,$=""==$?t.css("padding-bottom"):$,_=-1==_.indexOf("%")?_.replace(n,"")+"px":_,g=-1==g.indexOf("%")?g.replace(n,"")+"px":g,v=-1==v.indexOf("%")?v.replace(n,"")+"px":v,$=-1==$.indexOf("%")?$.replace(n,"")+"px":$):b=t.css("padding"),b=""==b?v+" "+g+" "+$+" "+_:b;var y="",x="";1==a.find("input[name=font_style]:checked").val()?(y=a.find("input[name=font_color]").val(),x=a.find("input[name=font_size]").val().replace(n,"")+"px"):(y=t.css("color"),x=t.css("font-size"));var k="",w="",I="",S="",C="";if(1==a.find("input[name=bg_style]:checked").val())switch(k=a.find("input[name=bg_color]").val(),w=a.find(".display_more_pic").find("li").attr("data-identify"),I="url("+w+")",bgpic_style=parseInt(a.find("select[name=bgpic_style]").val()),bgpic_style){case 0:S="100% 100%",C="no-reapt";break;case 1:C="no-reapt";break;case 2:C="repeat-x";break;case 3:C="repeat-y"}else k=t.css("background-color"),I=t.css("background-url"),S=t.css("background-size"),C=t.css("background-reapt");if("LI"==t[0].nodeName){var T=a.find("input[name=width_style]:checked").val(),P=t.parent("ul").css("width").replace(n,""),E="";1==T?-1==(E=-1==(E=""==(E=a.find("input[name=li_width]").val())?t.css("width"):E).indexOf("%")?E.replace(n,""):E).indexOf("%")||(E=E):E="mainIcon-pro"==i?"48.5%":t.css("width").replace(n,"")/P*100+"%";var O=a.find("input[name=item_picw_style]:checked").val(),L=t.css("width").replace(n,""),z="",B="";B=100-(z=1==O?-1==(z=-1==(z=""==(z=a.find("input[name=li_img_width]").val())?t.find("img").css("width"):z).indexOf("%")?z.replace(n,""):z).indexOf("%")?z/L*100+"%":z:(z=t.find("img").css("width").replace(n,""))/L*100+"%").replace(/\%/g,"")-5+"%";var j="";j=1==(O=a.find("input[name=item_pic_style]:checked").val())?-1==(j=""==(j=a.find("input[name=li_img_height]").val())?t.find("img").css("height"):j).indexOf("%")?j.replace(n,"")+"px":j:"";var A="",D="";1==a.find("input[name=head_style]:checked").val()?(A=a.find("input[name=head_font_color]").val(),D=a.find("input[name=head_font_size]").val().replace(n,"")+"px"):(A=t.find("p").css("color"),D=t.find("p").css("font-size")),1==a.find("input[name=price_style]:checked").val()?(price_c=a.find("input[name=price_font_color]").val(),price_f=a.find("input[name=price_font_size]").val().replace(n,"")+"px"):(price_c=t.find(".pro_vip_price").css("color"),price_f=t.find(".pro_vip_price").css("font-size")),1==a.find("input[name=cost_style]:checked").val()?(cost_c=a.find("input[name=cost_font_color]").val(),cost_f=a.find("input[name=cost_font_size]").val().replace(n,"")+"px"):(cost_c=t.find(".pro_price").css("color"),cost_f=t.find(".pro_price").css("font-size"))}t.css({border:r,"border-radius":s,height:c,width:E,margin:h,padding:b,color:y,"font-size":x,background:I,"background-repeat":C,"background-color":k,"background-size":S}),"LI"==t[0].nodeName&&(t.find("p").css({color:A,"font-size":D}),t.find(".pro_vip_price").css({color:price_c,"font-size":price_f}),t.find(".pro_price").css({color:cost_c,"font-size":cost_f})),"mainIcon-adv"==i&&(t.find("li").css({height:c}),t.css({height:""})),"mainIcon-col"==i&&(t.parent("ul").find("li").css({border:r,"border-radius":s,height:c,width:E,margin:h,padding:b,color:y,"font-size":x}),t.parent(".module").css({background:I,"background-repeat":C,"background-color":k,"background-size":S}),t.parent("ul").find("li").find("img").css({height:j}),t.css({border:r,"border-radius":s,height:"",width:E,margin:h,padding:b,color:y,"font-size":x})),"mainIcon-pro"==i&&(t.parent("ul").find("li").find("img").css({height:j,width:z}),t.parent(".module").css({background:I,"background-repeat":C,"background-color":k,"background-size":S}),t.parent("ul").css({height:""}),t.css({height:""})),"mainIcon-dis"==i&&(t.parent(".module").css({background:I,"background-repeat":C,"background-color":k,"background-size":S}),t.parent("ul").find("li").find("img").css({height:j,width:z}),t.parent("ul").css({height:""}),t.css({height:""}),t.parent("ul").find("li").find(".dis_txt").css({width:B}))}function f(e,t,i){var a="";return a+='<tr class="image_item">',a+='<td style="vertical-align: middle;">'+e+"</td>",a+='<td style="vertical-align: middle;width:100px;"><img style="width:80px;" src="'+t+'"></td>',a+='<td style="vertical-align: middle;">',a+='<input class="sku_id" type="text" name="sku_id[]" placeholder="SKUID" value="'+i+'" style="width:100px;">',a+="</td>",a+="</tr>"}var h=(new Date).getTime(),_=openDatabase("mobileCms","1.0","mobileCms DB",2097152);_.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS mobilelist (mIndex,mTime,mStr)")}),e();var g=$("#setStyle").find(".modal-body").html();localStorage.setItem("setStyle",g),$(".mobiReview").mCustomScrollbar({scrollInertia:1e3,mouseWheelPixels:100});new Swiper(".swiper-container",{pagination:".pagination",autoplay:2e3,speed:300,loop:!0,observer:!0,observeParents:!0,autoplayDisableOnInteraction:!1});$(".color").colorpicker();var v=/msie/i.test(navigator.userAgent)&&!window.opera;$("body").on("change",".more_pic",function(){$(this);if(v&&!$(this).files){var e=$(this).value;new ActiveXObject("Scripting.FileSystemObject").GetFile(e).Size}else for(var t=parseInt($(this).context.files.length),i=0,a=0;a<t;a++)if(parseInt($(this).context.files[a].size)/1024>200){$(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("图片不能超过200kb");$(this).parents("td").html('<input  type="file" class="more_pic" name="more_pic[]" value="" multiple="" >'),n()}else i+=$(this).context.files[a].size}),n();var b=!1,y=[],x="";$(".image_upload").on("submit",function(e){var t=$(this),i=$(this).find("input[type=file]");e.preventDefault();var a=i.data("ace_input_files");if(!a||0==a.length)return!1;"FormData"in window&&(formData_object=new FormData,$.each($(this).serializeArray(),function(e,t){formData_object.append(t.name,t.value)}),$(this).find("input[type=file]").each(function(){var e=$(this).attr("name"),t=$(this).data("ace_input_files");if(t&&t.length>0)for(var i=0;i<t.length;i++)formData_object.append(e,t[i])}),b=!0,$.ajax({url:$(this).attr("action"),type:$(this).attr("method"),processData:!1,contentType:!1,dataType:"json",data:formData_object,success:function(e){if(e.success){b=!1,y=e.data,console.log(y);for(val in y)x+="<li data-identify="+y[val].pic+'><img class="img-thumbnail" src="'+y[val].pic+'"/></li>';t.parent(".profile-info-value").next(".display_more_pic").html(""),t.parent(".profile-info-value").next(".display_more_pic").append(x),x="",$(".more_pic").val(),$("span.ace-file-container").empty().attr("data-title","请点击上传").append('<span class="ace-file-name" data-title="New File ..."><i class=" ace-icon fa fa-upload"></i></span>')}else bootbox.alert(e.msg)}}))}),$(".display_style").click(function(){$(this).find("div").attr("class","display_style_checked"),$(this).siblings().find("div").attr("class","")}),$(".add_btn").click(function(){$(this).parent("p").next("form").find(".image_content").append(o()),n()}),$("#mainIcon-more").on("click",".item_del",function(){$(this).parents("tr").remove()}),$("#mainIcon-adv").on("click",".item_del",function(){$(this).parents("tr").remove()}),$("#mainIcon-col").on("click",".item_del",function(){$(this).parents("tr").remove()}),$(".add_btn_tr").click(function(){$(this).parent("p").next("form").find(".image_content").append('<tr class="image_item"><td style="vertical-align: middle;"><input class="sku_id" type="text" name="sku_id[]" placeholder="skuid/其他" style="width:100px;"></td><td style="vertical-align: middle;max-width:100px;"><img class = "goodsimglogo" style="width:100%;" src=""></td><td style="vertical-align: middle;width:150px;"><input  type="file" class="more_pic" name="more_pic[]" multiple="" ></td><td style="vertical-align: middle;"><h5><span  class="blue">商品名称：</span><span class="goodsname"></span></h5><h5><span  class="blue">活动价：</span><span class="goodsshopprice"></span></h5><h5><span  class="blue">原价：</span><span class="goodsmarketprice"></span></h5></td><td style="vertical-align: middle;text-align:center;"><i class="item_del red ace-icon fa fa-trash-o bigger-150"></i></td></tr>'),n()}),$("#mainIcon-pro").on("click",".item_del",function(){$(this).parents("tr").remove()}),$("#mainIcon-dis").on("click",".item_del",function(){$(this).parents("tr").remove()}),l("#mainIcon-more"),l("#mainIcon-adv"),l("#mainIcon-col"),l("#mainIcon-pro"),l("#mainIcon-dis"),$("#mainIcon-pro").on("blur",".sku_id",function(){d($(this))}),$("#mainIcon-dis").on("blur",".sku_id",function(){d($(this))}),s("#mainIcon-more"),s("#mainIcon-adv"),s("#mainIcon-col"),c(".mainIcon-adv","adv_pic","#save_adv_pic"),c(".mainIcon-col","list_more_h","#save_list_pic"),$(".mainIcon-more").click(function(){void 0!=$(".mobiContant").find("#module_more").html()&&$(".mobiContant").find("#module_more").remove();$(".mobiContant").prepend('<div id="module_more" class="module module_1101"><div class="swiper-container modulePanel" data-id="mainIcon-more"><div class="swiper-wrapper"></div><div class="pagination"></div></div></div>'),$(".mobiContant").find("#module_more").prepend(m()),$("#save_more_pic").unbind("click").click(function(){var e=r($(this)),t=$(this).parents(".modal").attr("id");if(-1==$.inArray("",e.arrTbVal)&&-1==$.inArray("0",e.arrTbImg))if(e.numTbLen==e.ulTbLen){$(".swiper-container").show();for(var i=y.length,l="",d=0;d<i;d++)l+='<div class="swiper-slide"> ',1==y[d].pic_target?l+="<a data-target="+y[d].pic_target+' target="_blank" class="open-goods-detail"  data-goods-id="'+y[d].sku_id+'">':2==y[d].pic_target?l+="<a data-target="+y[d].pic_target+'  target="_blank" class="open-shop"  data-shop-id="'+y[d].sku_id+'">':l+='<a href="'+y[d].pic_link+'"   data-target='+y[d].pic_target+'  target="_blank"  data-goods-id="'+y[d].sku_id+'">',l+='<img src="'+y[d].pic+'">',l+=" </a> ",l+="</div>";$(".swiper-wrapper").html(l),$(".swiper-wrapper").parent(".swiper-container").attr("data-id",t);var s=[];$(".swiper-wrapper").find(".swiper-slide").each(function(){s.push($(this).find("img").height())});var c="";c=Math.min.apply(null,s),$(".swiper-wrapper").parent(".swiper-container").css({height:c}),$(this).parent(".modal-footer").prev(".modal-body").find(".image_content").html(o(0)),$(this).parent(".modal-footer").prev(".modal-body").find(".display_more_pic").html(""),n();var m=$(".mobiContant").find(".module").length;$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();a("mContent",m,$(".mobiContant").html());$("#module_more").find(".swiper-slide-duplicate").remove();a("module_1101","",$("#module_more").html()),$("#"+t).modal("hide")}else $(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("请上传参数!");else $(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("参数不能为空!")})}),$(".mainIcon-pro").click(function(){var e=$("<div></div>"),t=$("<ul></ul>"),i=Math.floor(1e4*Math.random());e.attr("class","module module_"+i),t.attr("class","modulePanel list_more_v list_more_v_"+i),$(".mobiContant").append(e),$(".module_"+i).append(m()),$(".module_"+i).append(t),$("#save_pro_pic").unbind("click").click(function(){var e=$(this),t=r(e),o=$(this).parents(".modal").attr("id"),l=parseInt($("input[name=goods_info]:checked").val());if(-1==$.inArray("",t.arrTbVal)&&-1==$.inArray("0",t.arrTbImg))if(t.numTbLen==t.ulTbLen){var d=[],s={},c=[];e.parent(".modal-footer").prev(".modal-body").find(".image_content").find(".image_item").each(function(){var e=$(this).find(".sku_id").val();s={sku_id:e,pic:""},d.push(s),c.push(e)});for(var m=c.join(",")+",",u=0;u<c.length;u++)if(m.replace(c[u]+",","").indexOf(c[u]+",")>-1)return $(".alert_txt").show(),void $(".alert_txt").find(".modal-body").html("楼层重复元素为"+c[u]+"请核对!");y.forEach(function(e,t,i){d.forEach(function(t){e.sku_id==t.sku_id&&(t.pic=e.pic)})});var f="";$.ajax({url:"/mobile/getgoods.html",type:"POST",dataType:"json",async:!1,data:{sku_id:d},success:function(e){for(var t=e.data,i=0;i<e.data.length;i++)f+="<li>",f+='<a target="_blank"  class="open-goods-detail"  data-goods-id="'+t[i].Sku_ID+'">',f+='<img src="'+t[i].S_Logo+'" data-lazy-src="'+t[i].S_Logo+'"/>',0==l&&(f+="<p>"+t[i].S_Name+"</p>",f+="<div>",f+='<span class="pro_vip_price">￥'+t[i].S_ShopPrice+"</span>",f+='<span class="pro_price">￥'+t[i].S_MarketPrice+"</span>",f+="</div>"),f+="</a>",f+="</li>"}}),$(".list_more_v_"+i).append(f),$(".list_more_v_"+i).attr("data-id",o);var h=[];$(".list_more_v_"+i).find("li").each(function(){h.push($(this).find("img").height())});Math.min.apply(null,h),$(".list_more_v_"+i).find("li").each(function(){$(this).prepend(p())}),$(this).parent(".modal-footer").prev(".modal-body").find(".image_content").html('<tr class="image_item"><td style="vertical-align: middle;"><input class="sku_id" type="text" name="sku_id[]" placeholder="skuid/其他" style="width:100px;"></td><td style="vertical-align: middle;max-width:100px;"><img class = "goodsimglogo" style="width:100%;" src=""></td><td style="vertical-align: middle;width:150px;"><input  type="file" class="more_pic" name="more_pic[]" multiple="" ></td><td style="vertical-align: middle;"><h5><span  class="blue">商品名称：</span><span class="goodsname"></span></h5><h5><span  class="blue">活动价：</span><span class="goodsshopprice"></span></h5><h5><span  class="blue">原价：</span><span class="goodsmarketprice"></span></h5></td><td style="vertical-align: middle;text-align:center;"><i class="item_del red ace-icon fa fa-trash-o bigger-150"></i></td></tr>'),$(this).parent(".modal-footer").prev(".modal-body").find(".display_more_pic").html(""),n();var _=$(".mobiContant").find(".module").length;$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();a("mContent",_,$(".mobiContant").html());a("module_"+i,"",$(".module_"+i).html()),$("#"+o).modal("hide")}else $(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("请上传参数!");else $(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("参数不能为空!")})}),$(".mainIcon-dis").click(function(){var e=$("<div></div>"),t=$("<ul></ul>"),i=Math.floor(1e4*Math.random());e.attr("class","module module_"+i),t.attr("class","modulePanel dis_pic dis_pic_"+i),$(".mobiContant").append(e),$(".module_"+i).append(m()),$(".module_"+i).append(t),$("#save_dis_pic").unbind("click").click(function(){var e="";$(this).parents("#mainIcon-dis").find(".modal-body").find(".display_style").each(function(){"display_style_checked"==$(this).find("div").attr("class")&&(e=parseInt($(this).index()))});var t=$(this).parents(".modal").attr("id"),o=$(this),l=r(o);if(-1==$.inArray("",l.arrTbVal)&&-1==$.inArray("0",l.arrTbImg))if(l.numTbLen==l.ulTbLen){var d=[],s={},c=[];o.parent(".modal-footer").prev(".modal-body").find(".image_content").find(".image_item").each(function(){var e=$(this).find(".sku_id").val();s={sku_id:e,pic:""},d.push(s),c.push(e)});for(var m=c.join(",")+",",u=0;u<c.length;u++)if(m.replace(c[u]+",","").indexOf(c[u]+",")>-1)return $(".alert_txt").show(),void $(".alert_txt").find(".modal-body").html("楼层重复元素为"+c[u]+"请核对!");y.forEach(function(e,t,i){d.forEach(function(t){e.sku_id==t.sku_id&&(t.pic=e.pic)})});var f="";$.ajax({url:"/mobile/getgoods.html",type:"POST",dataType:"json",async:!1,data:{sku_id:d},success:function(t){for(var i=t.data,a=0;a<i.length;a++)f+="<li>",f+='<a  target="_blank" class="open-goods-detail"  data-goods-id="'+i[a].Sku_ID+'">',f+=1==e?'<img style="margin-left:3%;float:right;" class="dis_img" src="'+i[a].S_Logo+'" data-lazy-src="'+i[a].S_Logo+'"/>':'<img style="margin-right:3%;float:left;" class="dis_img" src="'+i[a].S_Logo+'" data-lazy-src="'+i[a].S_Logo+'"/>',f+='<div class="dis_txt" style="float:left;">',f+="<p>"+i[a].S_Name+"</p>",f+='<div class="dis_price">',f+='<span class="pro_vip_price">￥'+i[a].S_ShopPrice+"</span>&nbsp;&nbsp;",f+=' <span class="pro_price">￥'+i[a].S_MarketPrice+"</span>",f+="</div>",f+="</div>",f+="</a>",f+="</li>"}}),$(".dis_pic_"+i).append(f),$(".dis_pic_"+i).attr("data-id",t);var h=[];$(".dis_pic_"+i).find("li").each(function(){h.push($(this).find("img").height())});var _="";_=Math.min.apply(null,h),$(".dis_pic_"+i).find("li").each(function(){$(this);$(this).find("img").css({height:_+"px"})}),$(".dis_pic_"+i).find("li").each(function(){$(this).prepend(p())}),$(this).parent(".modal-footer").prev(".modal-body").find(".image_content").html('<tr class="image_item"><td style="vertical-align: middle;"><input class="sku_id" type="text" name="sku_id[]" placeholder="skuid/其他" style="width:100px;"></td><td style="vertical-align: middle;max-width:100px;"><img class = "goodsimglogo" style="width:100%;" src=""></td><td style="vertical-align: middle;width:150px;"><input  type="file" class="more_pic" name="more_pic[]" multiple="" ></td><td style="vertical-align: middle;"><h5><span  class="blue">商品名称：</span><span class="goodsname"></span></h5><h5><span  class="blue">活动价：</span><span class="goodsshopprice"></span></h5><h5><span  class="blue">原价：</span><span class="goodsmarketprice"></span></h5></td><td style="vertical-align: middle;text-align:center;"><i class="item_del red ace-icon fa fa-trash-o bigger-150"></i></td></tr>'),$(this).parent(".modal-footer").prev(".modal-body").find(".display_more_pic").html(""),n();var g=$(".mobiContant").find(".module").length;$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();a("mContent",g,$(".mobiContant").html());a("module_"+i,"",$(".module_"+i).html()),$("#"+t).modal("hide")}else $(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("请上传参数!");else $(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("参数不能为空!")})}),$(".mobiContant").on("mouseover",".module",function(e){$(this).find(".modulePanel").attr("data-id"),$(this).index(),$(this).find(".modulePanelBg").addClass("modulePanelHover"),$(this).find(".modulePanel").find("li").find(".moduleItemBg").addClass("moduleActionBtn")}),$(".mobiContant").on("mouseout",".module",function(e){$(this).find(".modulePanelBg").removeClass("modulePanelHover"),$(this).find(".modulePanel").find("li").find(".moduleItemBg").removeClass("moduleActionBtn")}),$(".mobiContant").on("click",".module_del",function(){$(".alert").show();var e=$(this);$(".suc_btn").unbind("click").click(function(){$(".alert").hide(),e.parents(".modulePanelBg").parent(".module").remove();$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();var t=$(".mobiContant").html();i("mContent",h,t)})}),$(".mobiContant").on("click",".module_up",function(){var e=$(this).parents(".module");$(this).parents(".module").prev(".module").before(e),$(this).parents(".modulePanelBg").removeClass("modulePanelHover");$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();var t=$(".mobiContant").html();i("mContent",h,t)}),$(".mobiContant").on("click",".module_down",function(){var e=$(this).parents(".module");$(this).parents(".module").next(".module").after(e),$(this).parents(".modulePanelBg").removeClass("modulePanelHover");$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();var t=$(".mobiContant").html();i("mContent",h,t)}),$(".alert_close").click(function(){$(".alert").hide(),$(".alert_txt").hide()}),$("#setStyle").on("blur","input[type=text]",function(){var e=/^[0-9a-zA-a#%]*$/g,t=$(this).val();e.test(t)||($(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("请输入数字、字母!"),$(this).val(""))}),$("#setStyle").on("click",".ruleSettingTab",function(){$(".basicSetting").show(),$(".contentSetting").hide(),$(".topLevelSetting").hide()}),$("#setStyle").on("click",".contentSettingTab",function(){$(".contentSetting").show(),$(".basicSetting").hide(),$(".topLevelSetting").hide()}),$("#setStyle").on("click",".topLevelSettingTab",function(){$(".topLevelSetting").show(),$(".basicSetting").hide(),$(".contentSetting").hide()}),$("#setStyle").on("click",".choose_style",function(){0==$(this).val()?$(this).parents(".form-group").next(".form-group").hide():$(this).parents(".form-group").next(".form-group").show()});$(".mobiContant").on("click",".set_module",function(){-1!=$(this).parent().attr("class").indexOf("modulePanelBg")&&$(".topLevelSettingTab").hide();var e=$(this).parent(".modulePanelBg").next(".modulePanel"),t=$(this).parent(".modulePanelBg").next(".modulePanel").attr("data-id");console.log(t),$("#set_module_style").unbind("click").click(function(){u($(this),e,t);$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();var a=$(".mobiContant").html();i("mContent",h,a);var o=localStorage.getItem("setStyle");$("#setStyle").find(".modal-body").html(o),$(".color").colorpicker(),n()})});$(".mobiContant").on("click",".moduleItemDel",function(){$(".alert").show();var e=$(this);$(".suc_btn").unbind("click").click(function(){$(".alert").hide(),e.parents("li").remove();$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();var t=$(".mobiContant").html();i("mContent",h,t)})}),$(".mobiContant").on("click",".moduleItemEdit",function(){$(this).parents("li");var e=$(this).parent().attr("class");console.log(e.indexOf("modulePanelBg")),-1==e.indexOf("modulePanelBg")&&$(".topLevelSettingTab").show();var t=$(this).parents("li"),a=$(this).parent(".moduleItemBg").parents("ul").attr("data-id");console.log(a),$("#set_module_style").unbind("click").click(function(){u($(this),t,a);$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();var e=$(".mobiContant").html();i("mContent",h,e);var o=localStorage.getItem("setStyle");$("#setStyle").find(".modal-body").html(o),$(".color").colorpicker(),n()})}),$(".mobiContant").on("click",".edit_module",function(){$(".edit_part_modal").html(""),$("#modalEdit").find(".image_content").html("");var e=$(this).parent(".modulePanelBg").next().attr("data-id"),t="";switch(e){case"mainIcon-more":t="轮播图";break;case"mainIcon-adv":t="广告图";break;case"mainIcon-col":t="列表多图";break;case"mainIcon-pro":t="产品展示";break;case"mainIcon-dis":t="图文展示"}$(".modalName").html(t);var i=$(this).parents(".module").attr("class"),o=(i=i.split(" "))[1];_.transaction(function(t){t.executeSql('SELECT * FROM mobilelist WHERE mIndex = "'+o+'"',[],function(t,i){if(console.log("查询数据成功!"),i.rows.length>0){var l=i.rows[0].mStr;if($(".edit_part_modal").html(l),"mainIcon-more"==e||"mainIcon-adv"==e||"mainIcon-col"==e){$("#modalEdit").find("thead").find(".changeView").hide();d=0;$(".edit_part_modal").find(".modulePanel").find(".open-goods-detail").each(function(){d+=1;var e=$(this).attr("data-goods-id"),t=$(this).find("img").attr("src");$("#modalEdit").find(".image_content").append(f(d,t,e))}),$("#save_modal_edit").click(function(){var t=$(this).parents("#modalEdit").find(".image_content"),i=[];if(t.find("input[type=text]").each(function(){i.push($(this).val())}),-1==$.inArray("",i)){if("mainIcon-more"!=e)t.find("tr").each(function(){var e=$(this).find(".sku_id").val();$("."+o).find("li").eq(""+$(this).index()).find(".open-goods-detail").attr("data-goods-id",e)});else{var n="";t.find("tr").each(function(){var e=$(this).find(".sku_id").val(),t=$(this).find("img").attr("src");n+='<div class="swiper-slide"> <a class="open-goods-detail"  data-goods-id="'+e+'"><img src="'+t+'"> </a> </div>'}),$(".module_1101").find(".swiper-wrapper").html(n)}var l=$(".mobiContant").find(".module").length;$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();a("mContent",l,$(".mobiContant").html());a(o,"",$("."+o).html()),$("#modalEdit").modal("hide")}else $(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("参数不能为空!")})}else{$("#modalEdit").find("thead").find(".changeView").show();var d=0;$(".edit_part_modal").find(".modulePanel").find(".open-goods-detail").each(function(){d+=1;var e=$(this).attr("data-goods-id"),t=$(this).find("img").attr("src");$("#modalEdit").find(".image_content").append(f(d,t,e)),n()}),$("#save_modal_edit").click(function(){var e=$(this).parents("#modalEdit").find(".image_content"),t=[];if(e.find("input[type=text]").each(function(){t.push($(this).val())}),-1==$.inArray("",t)){e.find("tr").each(function(){var e=$(this).find(".sku_id").val();$("."+o).find("li").eq(""+$(this).index()).find(".open-goods-detail").attr("data-goods-id",e)});var i=$(".mobiContant").find(".module").length;$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove();a("mContent",i,$(".mobiContant").html());a(o,"",$("."+o).html()),$("#modalEdit").modal("hide")}else $(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("参数不能为空!")})}}},function(e,t){console.log(t.source+"::"+t.message)})})}),$(".save_all").click(function(){$(".mobiContant").find("#module_more").find(".swiper-slide-duplicate").remove(),$(".mobiContant").find(".module").find(".modulePanelBg").remove(),$(".mobiContant").find(".module").find(".modulePanel").find(".moduleItemBg").remove();var e=$(".mobiContant").parent().html(),t=$("#S_Code").val();$.base64.utf8encode=!0;var i=$.base64.btoa(t);console.log(i);var a=$("input[name='url_sale']").val();$.ajax({url:"/mobile/save.html?S_Code="+t,type:"POST",dataType:"json",data:{save_AllData:e,value_cms:i},success:function(e){e.success?($(".alert_txt").show(),$(".alert_txt").find(".modal-body").html(e.msg),_.transaction(function(e){e.executeSql("drop table mobilelist")}),window.location.href=a+"activity/add.html?S_Code="+t+"&value="+i):($(".alert_txt").show(),$(".alert_txt").find(".modal-body").html("保存失败！"))}})});$(".mobiReview").find(".module").each(function(){var e=$(this);void 0==e.find("modulePanelBg").html()&&e.prepend('<div class="modulePanelBg"><button data-toggle="modal" data-target="#modalEdit" class="edit_module btn btn-primary btn-xs ">编辑模块</button><button data-toggle="modal" data-target="#setStyle" class="set_module btn btn-primary btn-xs ">设置样式</button><div class="moduleBtn action-buttons"><span class="module_del"><a><i class="fa fa-times" aria-hidden="true"></i></a></span><span class="module_up"><a><i class="fa fa-long-arrow-up" aria-hidden="true"></i></a></span><span class="module_down"><a><i class="fa fa-long-arrow-down" aria-hidden="true"></i></a></span></div></div>')}),$(".mobiReview").find(".module").find(".modulePanel").find("li").each(function(){var e=$(this);void 0==e.find("moduleItemBg").html()&&e.prepend('<a class="moduleItemBg"><span data-toggle="modal" data-target="#setStyle" class="moduleItemEdit"><i class="fa fa-pencil" aria-hidden="true"></i></span><span class="moduleItemDel"><i class="fa fa-times" aria-hidden="true"></i></span></a>')})});